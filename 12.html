<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>تسجيل صوت ورفعه إلى Google Drive</title>
</head>
<body>
  <h2>🎤 تسجيل صوت ورفعه إلى Google Drive</h2>

  <button id="record">ابدأ التسجيل</button>
  <button id="stop" disabled>إيقاف التسجيل</button>
  <button id="upload" disabled>رفع إلى Google Drive</button>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let accessToken = '';

    // 👇 ضع هنا Client ID الخاص بك من Google Cloud Console
    const CLIENT_ID = 'PASTE_YOUR_CLIENT_ID_HERE';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    async function authenticate() {
      return new Promise((resolve, reject) => {
        const authWindow = window.open(
          `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=https://oauth.pstmn.io/v1/callback&response_type=token&scope=${SCOPES}`,
          '_blank',
          'width=500,height=600'
        );

        const interval = setInterval(() => {
          try {
            if (authWindow.location.hash) {
              const hashParams = new URLSearchParams(authWindow.location.hash.substring(1));
              accessToken = hashParams.get('access_token');
              authWindow.close();
              clearInterval(interval);
              resolve();
            }
          } catch (e) {}
        }, 500);
      });
    }

    document.getElementById('record').onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        document.getElementById('upload').disabled = false;
      };

      mediaRecorder.start();
      document.getElementById('record').disabled = true;
      document.getElementById('stop').disabled = false;
    };

    document.getElementById('stop').onclick = () => {
      mediaRecorder.stop();
      document.getElementById('stop').disabled = true;
    };

    document.getElementById('upload').onclick = async () => {
      if (!accessToken) {
        await authenticate();
      }

      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const metadata = {
        name: `recording_${Date.now()}.webm`,
        mimeType: 'audio/webm'
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', blob);

      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
        body: form
      });

      if (response.ok) {
        alert('✅ تم رفع الصوت بنجاح إلى Google Drive!');
      } else {
        alert('❌ حدث خطأ أثناء الرفع!');
        console.log(await response.text());
      }
    };
  </script>
</body>
</html>
