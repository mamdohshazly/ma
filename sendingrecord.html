<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ุชุณุฌูู ูุฅุฑุณุงู ุตูุช</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <!-- ๐ข ุงููุณู ุงูุฑุฆูุณู -->
  <div id="main-section">
    <h2>ุชุณุฌูู ุตูุช ูุฅุฑุณุงูู ุจุงูุจุฑูุฏ</h2>

    <label>ุงุณู ุงูููู:</label><br>
    <input type="text" id="filename" placeholder="ูุซุงู: my_audio"><br><br>

    <label>ุงุณูู:</label><br>
    <input type="text" id="senderName" placeholder="ุงุณูู"><br><br>

    <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุณุชูู:</label><br>
    <input type="email" id="receiverEmail" placeholder="user@example.com"><br><br>

    <button id="recordBtn">๐ค ุจุฏุก ุงูุชุณุฌูู</button>
    <button id="stopBtn" disabled>โน๏ธ ุฅููุงู</button>
    <button id="sendBtn" disabled>๐ค ุฅุฑุณุงู</button>

    <br><br>
    <audio id="audio" controls></audio>
  </div>

  <!-- ๐ต ุงููุณู ุงููุฑุนู: ุชุดุบูู ูุชุญููู -->
  <div id="play-section" class="hidden">
    <h2>โ ุชู ุฑูุน ุงูููู ูุชุดุบููู:</h2>
    <audio id="playAudio" controls style="width: 100%; max-width: 500px;"></audio>
    <br><br>
    <button id="downloadBtn">๐ฅ ุชุญููู ุงูููู</button>
  </div>

  <script>
    // ๐งฉ ุฅุนุฏุงุฏ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBhUtM-jMEyXcFGGqkg7NurScbj6yi3wjc",
      authDomain: "mamdoh-bc9a5.firebaseapp.com",
      projectId: "mamdoh-bc9a5",
      storageBucket: "mamdoh-bc9a5.appspot.com",
      messagingSenderId: "176483558007",
      appId: "1:176483558007:web:e9f17e0f62acd3231c5c72",
      measurementId: "G-QHNX5N7GG1"
    };

    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // ๐ง ุฅุนุฏุงุฏ EmailJS
    emailjs.init("74-zUyeR-o7zE76GL");

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const sendBtn = document.getElementById('sendBtn');
    const audio = document.getElementById('audio');

    recordBtn.onclick = async () => {
      const filename = document.getElementById("filename").value.trim();
      if (!filename) {
        alert("ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูููู ุฃููุงู.");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audio.src = URL.createObjectURL(audioBlob);
        sendBtn.disabled = false;
      };

      mediaRecorder.start();
      recordBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
    };

    sendBtn.onclick = async () => {
      const filename = document.getElementById("filename").value.trim();
      const receiverEmail = document.getElementById("receiverEmail").value.trim();
      const senderName = document.getElementById("senderName").value.trim();

      if (!receiverEmail || !senderName) {
        alert("ูุฑุฌู ุฅุฏุฎุงู ุงุณูู ูุจุฑูุฏ ุงููุณุชูู.");
        return;
      }

      try {
        const storageRef = storage.ref().child(`audio/${filename}.webm`);
        await storageRef.put(audioBlob);
        const downloadURL = await storageRef.getDownloadURL();

        // ุฅุฑุณุงู ุงูุจุฑูุฏ
        await emailjs.send("service_vlapjef", "template_p0wtlnj", {
          to_email: receiverEmail,
          file_link: downloadURL,
          sender_name: senderName
        });

        alert("โ ุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ!");

        // ุฅุธูุงุฑ ูุณู ุงูุชุดุบูู
        document.getElementById("main-section").classList.add("hidden");
        const playSection = document.getElementById("play-section");
        playSection.classList.remove("hidden");

        // ุชุดุบูู ุงูุตูุช
        const playAudio = document.getElementById("playAudio");
        playAudio.src = downloadURL;

        // ุชุญููู ุงูุตูุช
        const downloadBtn = document.getElementById("downloadBtn");
        downloadBtn.onclick = () => {
          const link = document.createElement("a");
          link.href = downloadURL;
          link.download = filename + ".webm";
          link.click();
        };

      } catch (error) {
        console.error("ุฎุทุฃ ูู ุงูุฅุฑุณุงู:", error);
        alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู.");
      }
    };
  </script>
</body>
</html>
